//
//  HNCFHomeViewController.m
//  HNCF
//
//  Created by Apple on 15/11/17.
//  Copyright © 2015年 hsy. All rights reserved.
//

#import "HNCFHomeViewController.h"
#import "HNCFCommmon.h"

@interface HNCFHomeViewController ()<HNCFHeadBrandViewDelegate,UITableViewDataSource,UITableViewDelegate,HNCFNaViewDelegate>
@property (nonatomic , strong) HNCFHeadBrandView *headBrandView;
@property (nonatomic , strong) UITableView *mainTableView;
@property (nonatomic , strong) HNCFNaView *naView;
@property (nonatomic , strong) NSMutableArray *shopList;
@property (nonatomic) NSInteger padeIndex;
@property (nonatomic) NSInteger bagIndex;
@property (nonatomic) NSString * cityString;

@end

@implementation HNCFHomeViewController
- (NSMutableArray *)shopList
{
    if (!_shopList) {
        _shopList = [NSMutableArray arrayWithCapacity:0];
    }
    return _shopList;
}
- (UITableView *)mainTableView
{
    if (!_mainTableView) {
        _mainTableView = [[UITableView alloc]initWithFrame:CGRectMake(0, self.headBrandView.maxY, HNCFWidth, HNCFHeight-self.headBrandView.height-64-49) style:UITableViewStylePlain];
        _mainTableView.separatorStyle = UITableViewCellSeparatorStyleNone;
        _mainTableView.delegate = self;
        _mainTableView.rowHeight = 260;
        _mainTableView.dataSource = self;
    }
    return _mainTableView;
}
- (HNCFHeadBrandView *)headBrandView
{
    if (!_headBrandView) {
        _headBrandView = [[HNCFHeadBrandView alloc]initWithFrame:CGRectMake(0, 0, HNCFWidth, HNCFWidth/3)];
        _headBrandView.delegate = self;
        _headBrandView.backgroundColor = [UIColor clearColor];
    }
    return _headBrandView;
}
- (HNCFNaView *)naView
{
    if (!_naView) {
        _naView = [[HNCFNaView alloc]initWithFrame:CGRectMake(0, 20, HNCFWidth, 44)];
        _naView.delegate = self;
    }
    return _naView;
}
- (void)viewWillAppear:(BOOL)animated
{
    [super viewWillAppear:animated];
    self.tabBarController.tabBar.hidden = NO;
    self.navigationController.navigationBar.hidden = NO;
    self.padeIndex = 1;
    [self location];

    [HNCFRequestManager fetchhomeAds:@{} success:^(id result) {
        NSInteger status = [[result objectForKey:@"code"]integerValue];
        if (status == 0) {
            [self.headBrandView setHomeBannerData:[result objectForKey:@"result"]];
        }
    } failure:^(NSError *error) {
        
    }];
    [HNCFRequestManager fetchhomeshop:@{@"page":[NSString stringWithFormat:@"%ld",self.padeIndex]} success:^(id result) {
        NSInteger status = [[result objectForKey:@"code"]integerValue];
        NSLog(@"shopList:%@",result);
        if (status == 0) {
            self.shopList = [result objectForKey:@"result"];
            [self.mainTableView reloadData];
        }
    } failure:^(NSError *error) {
        
    }];

}
- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view from its nib.
    [self.view addSubview:self.headBrandView];
    [self.view addSubview:self.mainTableView];
    self.bagIndex = 0;

}

- (void)didReceiveMemoryWarning {
    [super didReceiveMemoryWarning];
    // Dispose of any resources that can be recreated.
}
#pragma
#pragma mark - UITableViewDataSource
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section;
{
    return [self.shopList count];
}
- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath;
{
    static NSString *CellIdentifier = @"HNCFHomeCell";
    HNCFHomeCell *cell = [tableView dequeueReusableCellWithIdentifier:CellIdentifier];
    if (cell == nil) {
        NSArray *nib = [[NSBundle mainBundle] loadNibNamed:@"HNCFHomeCell" owner:self options:nil];
        cell = [nib objectAtIndex:0];
        
    }
    cell.shopButton.tag = indexPath.row;
    [cell.shopButton addTarget:self action:@selector(shopButtonSelect:) forControlEvents:UIControlEventTouchUpInside];
    id model = [self.shopList objectAtIndex:indexPath.row];
    cell.nameLabel.text = [NSString stringWithFormat:@"%@",[model objectForKey:@"title"]];
    NSAttributedString * attrStr = [[NSAttributedString alloc] initWithData:[[NSString stringWithFormat:@"%@",[model objectForKey:@"content"]] dataUsingEncoding:NSUnicodeStringEncoding] options:@{ NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentType } documentAttributes:nil error:nil];

       cell.contentLabel.attributedText =attrStr ;
    cell.subLabel.text = [NSString stringWithFormat:@"%@",[model objectForKey:@"description"]];
    cell.priceLabel.text = [NSString stringWithFormat:@"%@", [model objectForKey:@"sl_money"]];
    cell.topLabel.text = [NSString stringWithFormat:@"还剩%@份",[model objectForKey:@"def_renshu"]];
    cell.numLabel.text = [NSString stringWithFormat:@"%@",[model objectForKey:@"def_renshu"]];

    return cell;
}
-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath
{
    [tableView deselectRowAtIndexPath:indexPath animated:YES];
    id model = [self.shopList objectAtIndex:indexPath.row];

    HNCFHomeDetailViewController *homeDetailViewController = [[HNCFHomeDetailViewController alloc]init];
    homeDetailViewController.model = model;
    [self.navigationController pushViewController:homeDetailViewController animated:YES];
    
}
#pragma
#pragma mark - HNCFHeadBrandViewDelegate
- (void)HNCFHeadBrandView:(HNCFHeadBrandView *)bannerView didSelectItem:(NSDictionary *)itemData Index:(NSInteger)index;
{
    
}
#pragma
#pragma mark - location
- (void)location
{
    //    self.locationManager = [[CLLocationManager alloc] init];
    //    // 设置定位精度，十米，百米，最好
    //    [self.locationManager setDesiredAccuracy:kCLLocationAccuracyNearestTenMeters];
    //    self.locationManager.delegate = self;
    //    // 开始时时定位
    //    [self.locationManager startUpdatingLocation];
    [MJProgressHUD showHUDWithText1:@"加载中"];
    //只获取一次定位
    __block  BOOL isOnece = YES;
    [HNCFLocation getGps:^(double lat, double lng ,NSString *city) {
        isOnece = NO;
        self.cityString = city;
        [self.naView setHomeBannerData:city locationImage:NO rightButton:NO leftButton:YES];
        self.navigationItem.titleView = self.naView;
        [MJProgressHUD hide1];
        //        [self.locationTableView reloadSections:[NSIndexSet indexSetWithIndex:0] withRowAnimation:UITableViewRowAnimationFade];
        if (!isOnece) {
            [HNCFLocation stop];
            [MJProgressHUD hide1];

        }
    }];
}
#pragma
#pragma mark - leftMenu
- (void)didSelectLeft;
{
    
}
#pragma
#pragma mark - rightSearch
- (void)didSelectRight;
{
    HNCFSearchViewController *searchViewController = [[HNCFSearchViewController alloc]init];
    [self.navigationController pushViewController:searchViewController animated:YES];
}
- (void)shopButtonSelect:(UIButton *)sender
{
    id model = [self.shopList objectAtIndex:[sender tag]];
    
    [HNCFRequestManager fetchShopAdd:@{@"pay_type":@"5",@"goodsid":[model objectForKey:@"sl_id"],@"shopid":[model objectForKey:@"sl_dianid"],@"shopname":[model objectForKey:@"sl_title"],@"gonumber":@"",@"moneycount":@"",@"add_street":self.cityString,@"add_username":@"",@"add_phone":@""} success:^(id result) {
        NSInteger code = [[result objectForKey:@"code"]integerValue];
        if (code ==0) {
            NSLog(@"%@",result);
            self.bagIndex ++;
            [self setBadgeValue:[NSString stringWithFormat:@"%ld",(long)self.bagIndex] atTabIndex:2];
        }
        
    } failure:^(NSError *error) {
        
    }];
   
}
-(void)setBadgeValue:(NSString*)val atTabIndex:(int)index

{
    
    // UITabBarItem* tab = [ objectAtIndex:2*index];
    
    UITabBarItem* tab = [[self.tabBarController.tabBar items] objectAtIndex:index];
    
    if ([val integerValue] <= 0) {
        
        tab.badgeValue = nil;
        
    }
    
    else
        
    {
        
        tab.badgeValue = val;
        
    }
    
}
@end
